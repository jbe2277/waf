name: NewsReader.CI

on: 
  push:
    paths: 
      - 'src/NewsReader/**'
      - '.github/workflows/**' 

jobs:
  Android:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v3
    #- name: Install .NET MAUI
    #  run: |
    #    dotnet nuget locals all --clear
    #    dotnet workload install maui android
    - name: Install MinVer
      run: |
        dotnet tool install minver-cli -g
    - name: Get Build Version
      run: |
        $verOut=minver -t v
        $metaSplit=$verOut.Split('+', 2)
        $preSplit=$metaSplit[0].Split('-', 2)
        $rtmSplit=$preSplit[0].Split('.')
        echo version=$($preSplit[0]) | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
        $versionCode = [string]::Format("{0}{1}{2}", $rtmSplit[0], $rtmSplit[1].PadLeft(2, '0'), $rtmSplit[2].PadLeft(4, '0'))
        echo versionCode=$versionCode | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh
    - name: Build
      run: |
        cd src/NewsReader/NewsReader.MauiSystem
        dotnet publish -f:net7.0-android -c:Debug -p:ApplicationVersion=${{ env.versionCode }} -p:ApplicationDisplayVersion=${{ env.version }}   # Workaround for https://github.com/dotnet/linker/issues/3126

  Windows:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v3
    - name: Install .NET MAUI
      run: |
        dotnet nuget locals all --clear
        dotnet workload install maui
    - name: Build
      run: |
        cd src/NewsReader/NewsReader.MauiSystem
        dotnet publish -f:net7.0-windows10.0.19041.0 -c:Release

  iOS:
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v3
      - name: Set Xcode version
        run: |
          XCODE_ROOT=/Applications/Xcode_14.2.app
          echo "MD_APPLE_SDK_ROOT=$XCODE_ROOT" >> $GITHUB_ENV       # set environment variable to specify Xcode for Mono and Xamarin
          sudo xcode-select -s $XCODE_ROOT
      - name: Install .NET MAUI
        run: |
          dotnet nuget locals all --clear 
          dotnet workload install maui ios
      - name: Build
        run: |
          cd src/NewsReader/NewsReader.MauiSystem
          dotnet build -f net7.0-ios -c Debug /p:packageApp=false /p:buildForSimulator=true /p:ArchiveOnBuild=false
        
  Test:
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v3
    - name: Domain.Test
      run: |
        cd src/NewsReader/NewsReader.Domain.Test
        dotnet test -c:Release
    - name: Presentation.Test
      run: |
        cd src/NewsReader/NewsReader.Presentation.Test
        dotnet test -c:Release
